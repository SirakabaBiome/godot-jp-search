{{- define "main" }}

{{ $file := "static/data/addon.json" }}

{{- if .Title }}
<header class="page-header">
    <h1>{{ .Title }}</h1>
    {{- if .Description }}
    <div class="post-description">
        {{ .Description }}
    </div>
    {{- end }}
</header>
{{- end }}

<article class="addon">
    <!--概要-->
    <div style="margin: 0 0 1em 0;">
        <p>
            Godot Engineのアドオンを一覧表示しています。 <a class="link" href="https://faultun.com/ko/addon">한국어</a> <a
                class="link" href="https://faultun.com/en/addon">English</a>
        </p>

        <h3>
            このサイトについて
        </h3>

        <div class="collapse" data-collapse-toggle="gaiyou">
            <p>
                TODO 概要はどこかにいい感じに書く
                概要、評価などはすべて筆者（ふぉるた）によるものです。<br>
                このサイトは非公式です。Godot公式・Godotコミュニティとは関係ありませんのでご注意ください。<br><br>
                誤りや追加要望があれば、こちらの<a class="link" href="https://forms.gle/DgCmjtGSSNrNojGW6">Google
                Form</a>からお知らせください。<br><br>
                Godot4〜のものを都度追加していきます。<br>
            </p>
            <!-- セパレーター  -->
            <hr>
            <p>
                個人的な考え<br>
                GitHubのスター数はそこまであてにならないと思っています。READMEの小綺麗さやyoutubeとかではねただけの可能性もあるので……<br>
                自分のゲームで使えるかどうかで判断するのが一番！<br><br>
                また、<img style="display: inline" gdicon src="/icon/AssetLib.svg" alt="AssetLib">AssetLibにないものが意外とスター数が少なくても良いものが多いイメージがあるので探してみてください。<br>
            </p>
            <!-- セパレーター  -->
            <hr>
            <p>
                ☑をつけた状態でブックマークすると検索条件を保存できます。<br>
            </p>
        </div>
    </div>

    {{ if (fileExists $file) }}
    {{ with (os.Stat $file) }}
    <p>最終更新日: {{ .ModTime.Format "2006-01-02" }}</p>
    {{ end }}
    {{ end }}

    <div class="filter-container">
        <details open>
            <summary>
                <h3>
                    検索条件
                </h3>
            </summary>
            <span class="pin-container">
                <button id="PinBtn" class="pin-btn" data-pin-btn>
                    📌
                    条件を上に固定する
                </button>
                <span class="labal-pin">

                </span>
            </span>
            <!-- セパレーター  -->
            <hr>

            <!-- タグフィルタ -->
            <div class="tag-filter">
                <div id="ForDuplicateExclude">
                    <details open>
                        <summary>
                            大分類
                        </summary>
                        <ul class="addon-tags" data-collapse-toggle="daibunrui">
                            <li>
                                <label data-commonly-tag>
                                    <input class="checkTag" data-check-tag type="checkbox" name="tag" value="2d">
                                    <img gdicon src="/icon/Node2D.svg" alt="Node2D">
                                    2D
                                    <sup></sup>
                                </label>
                            </li>
                            <li>
                                <label data-commonly-tag>
                                    <input class="checkTag" data-check-tag type="checkbox" name="tag" value="3d"/>
                                    <img gdicon src="/icon/Node3D.svg" alt="Node3D">
                                    3D
                                    <sup></sup>
                                </label>
                            </li>
                            <li>
                                <label data-commonly-tag>
                                    <input class="checkTag" data-check-tag type="checkbox" name="tag" value="ui"/>
                                    <img gdicon src="/icon/Control.svg" alt="Control">
                                    UI
                                    <sup></sup>
                                </label>
                            </li>
                            <li>
                                <label data-commonly-tag>
                                    <input class="checkTag" data-check-tag type="checkbox" name="tag" value="other"/>
                                    <img gdicon src="/icon/Node.svg" alt="Node">
                                    他
                                    <sup></sup>
                                </label>
                            </li>
                        </ul>

                        <ul class="addon-tags" data-collapse-toggle="daibunrui">
                            <li>
                                <label data-not-tag-condition>
                                    <input class="checkTag" data-check-tag type="checkbox" name="specialTag"
                                           value="notdemo"/>
                                    <i class="fas fa-fw fa-do-not-enter"></i>
                                    デモを除外する
                                    <sup></sup>
                                </label>
                            </li>
                            <li>
                                <label data-not-tag-condition>
                                    <input class="checkTag" data-check-tag type="checkbox" name="specialTag"
                                           value="withsummary"/>
                                    <i class="fas fa-fw fa-comment"></i>
                                    概要・解説付き
                                    <sup></sup>
                                </label>
                            </li>
                        </ul>
                    </details>
                    <!-- セパレーター  -->
                    <hr>

                    <details open>
                        <summary>
                            よく使いそうなタグ
                        </summary>
                        <ul class="addon-tags" data-collapse-toggle="specialtag">
                            <li>
                                <label data-commonly-tag>
                                    <input class="checkTag" data-check-tag type="checkbox" name="tag"
                                           value="animation"/>
                                    <img gdicon src="/icon/AnimationPlayer.svg" alt="Animation">
                                    アニメーション
                                    <sup></sup>
                                </label>
                            </li>
                            <li>
                                <label data-commonly-tag>
                                    <input class="checkTag" data-check-tag type="checkbox" name="tag" value="audio"/>
                                    <img gdicon src="/icon/AudioStream.svg" alt="AudioStream">
                                    オーディオ
                                    <sup></sup>
                                </label>
                            </li>
                            <li>
                                <label data-commonly-tag>
                                    <input class="checkTag" data-check-tag type="checkbox" name="tag"
                                           value="navigation"/>
                                    <img gdicon src="/icon/NavigationPolygon.svg" alt="NavigationPolygon">
                                    ナビゲーション
                                    <sup></sup>
                                </label>
                            </li>
                            <li>
                                <label data-commonly-tag>
                                    <input class="checkTag" data-check-tag type="checkbox" name="tag"
                                           value="multiplayer"/>
                                    <img gdicon src="/icon/MultiplayerSynchronizer.svg" alt="MultiplayerSynchronizer">
                                    マルチプレイ
                                    <sup></sup>
                                </label>
                            </li>
                            <li>
                                <label data-commonly-tag>
                                    <input class="checkTag" data-check-tag type="checkbox" name="tag" value="network"/>
                                    <img gdicon src="/icon/MultiplayerSynchronizer.svg" alt="MultiplayerSynchronizer">
                                    ネットワーク
                                    <sup></sup>
                                </label>
                            </li>
                            <li>
                                <label data-commonly-tag>
                                    <input class="checkTag" data-check-tag type="checkbox" name="tag" value="shader"/>
                                    <img gdicon src="/icon/Shader.svg" alt="Shader">
                                    シェーダー
                                    <sup></sup>
                                </label>
                            </li>
                            <li>
                                <label data-commonly-tag>
                                    <input class="checkTag" data-check-tag type="checkbox" name="tag" value="xr"/>
                                    <img gdicon src="/icon/XRCamera3D.svg" alt="XRCamera3D">
                                    AR/VR
                                    <sup></sup>
                                </label>
                            </li>
                            <li>
                                <label data-commonly-tag>
                                    <input class="checkTag" data-check-tag type="checkbox" name="tag" value="physics"/>
                                    <img gdicon src="/icon/ViewportSpeed.svg" alt="Physics">
                                    物理
                                    <sup></sup>
                                </label>
                            </li>
                        </ul>

                        <ul class="addon-tags" data-collapse-toggle="specialtag">
                            <li>
                                <label data-commonly-tag>
                                    <input class="checkTag" data-check-tag type="checkbox" name="tag"
                                           value="gdextension"/>
                                    GDExtension
                                    <sup></sup>
                                </label>
                            </li>
                            <li>
                                <label data-commonly-tag>
                                    <input class="checkTag" data-check-tag type="checkbox" name="tag" value="module"/>
                                    モジュール
                                    <sup></sup>
                                </label>
                            </li>
                            <li>
                                <label data-commonly-tag>
                                    <input class="checkTag" data-check-tag type="checkbox" name="tag"
                                           value="csharponly"/>
                                    C#のみ
                                    <sup></sup>
                                </label>
                            </li>
                            <li>
                                <label data-commonly-tag>
                                    <input class="checkTag" data-check-tag type="checkbox" name="tag"
                                           value="csharpwrapper"/>
                                    C#ラッパーあり
                                    <sup></sup>
                                </label>
                            </li>
                        </ul>
                        <!-- セパレーター  -->
                        <hr>

                        <ul class="addon-tags" data-collapse-toggle="specialtag">
                            <li>
                                <label data-commonly-tag>
                                    <input class="checkTag" data-check-tag type="checkbox" name="tag"
                                           value="editoronly"/>
                                    <img gdicon src="/icon/EditorPlugin.svg" alt="EditorPlugin">
                                    エディタのみ
                                    <sup></sup>
                                </label>
                            </li>
                            <li>
                                <label data-not-tag-condition>
                                    <input class="checkTag" data-check-tag type="checkbox" name="specialTag"
                                           value="assetlib"/>
                                    <img gdicon src="/icon/AssetLib.svg" alt="AssetLib">
                                    AssetLibにある
                                    <sup></sup>
                                </label>
                            </li>
                            <li>
                                <label data-not-tag-condition>
                                    <input class="checkTag" data-check-tag type="checkbox" name="specialTag"
                                           value="notassetlib"/>
                                    <img gdicon src="/icon/AssetLib.svg" alt="AssetLib">
                                    AssetLibにない
                                    <sup></sup>
                                </label>
                            </li>

                            <li>
                                <label data-not-tag-condition>
                                    <input class="checkTag" data-check-tag type="checkbox" name="specialTag"
                                           value="github"/>
                                    <i class="fab fa-fw fa-github"></i>
                                    GitHub
                                    <sup></sup>
                                </label>
                            </li>

                            <li>
                                <label data-not-tag-condition>
                                    <input class="checkTag" data-check-tag type="checkbox" name="specialTag"
                                           value="gitlab"/>
                                    <i class="fab fa-fw fa-gitlab"></i>
                                    GitLab
                                    <sup></sup>
                                </label>
                            </li>

                            <li>
                                <label data-commonly-tag>
                                    <input class="checkTag" data-check-tag type="checkbox" name="specialTag"
                                           value="other"/>
                                    <i class="fas fa-fw fa-link"></i>
                                    その他サイト
                                    <sup></sup>
                                </label>
                            </li>
                        </ul>

                    </details>
                    <!-- セパレーター  -->
                    <hr>

                    <details open>
                        <summary>
                            ライセンス他
                        </summary>
                        <ul id="FilterLicenseTags" class="addon-tags" data-collapse-toggle="license">
                            <li data-license-tag-template style="display: none">
                                <label data-tag-label>
                                    <input class="checkTag" data-check-tag type="checkbox" name="licenseTag" value=""
                                           data-tag-checkbox/>
                                    <span data-tag-label-text></span>
                                    <sup data-tag-sup></sup>
                                </label>
                            </li>
                        </ul>
                    </details>
                    <!-- セパレーター  -->

                    <hr>

                    <details open>
                        <summary>
                            タグ
                        </summary>

                        <ul id="FilterTags" class="addon-tags" data-collapse-toggle="tag">
                            <li data-tag-template style="display: none">
                                <label data-tag-label>
                                    <input class="checkTag" data-check-tag type="checkbox" name="tag" value=""
                                           data-tag-checkbox/>
                                    <span data-tag-label-text></span>
                                    <sup data-tag-sup></sup>
                                </label>
                            </li>
                        </ul>
                    </details>

                </div>

                <!-- セパレーター  -->
                <hr>
                フィルタ組み合わせ方法
                <!-- OR, And のラジオボタン -->
                <div class="block">
                    <label for="FilterAnd">
                        <input type="radio" id="FilterAnd" name="filter" value="and" checked>
                        AND
                    </label>
                    <label for="FilterOr">
                        <input type="radio" id="FilterOr" name="filter" value="or">
                        OR
                    </label>
                </div>
                <!-- セパレーター  -->
                <hr>

                <details>
                    <summary>
                        除外条件
                    </summary>
                    <div id="ExcludeTags" data-collapse-toggle="exclude" style="padding-left: 32px;">
                    </div>
                </details>
                <!-- セパレーター  -->
                <hr>

                <!-- ワード検索  -->

                <details open>
                    <summary>
                        ワード検索(部分一致)
                    </summary>
                    <div class="addon-search" data-collapse-toggle="search">
                        <!-- プルダウンで対象を選択 title, author, summary -->
                        <select id="SearchTarget">
                            <option value="any" selected>
                                全て
                            </option>
                            <option value="title">
                                アドオン名
                            </option>
                            <option value="author">
                                作者名
                            </option>
                            <option value="summary">
                                概要
                            </option>
                        </select>
                        <div id="searchbox">
                            <input id="SearchInput" placeholder="検索" type="text" autocomplete="off"
                                   oninput="update()">
                        </div>
                    </div>
                </details>
                <!-- セパレーター  -->
                <hr>


                <!-- 表示順 のラジオボタン -->
                <div class="addon-andor" data-collapse-toggle="order">
                    <!-- クリア -->
                    条件全削除
                    <button class="clear-btn" onclick="clearAll()">
                        すべて☑を外す
                    </button>

                    表示順
                    <select id="addon-order">
                        <option name="order" value="updated-addon-desc" id="order-updated-addon-desc">
                            アドオン最新日順
                        </option>
                        <option name="order" value="updated-addon-asc" id="order-updated-addon-asc">
                            アドオン古い日順
                        </option>
                        <option name="order" value="add-addon-desc" id="order-add-addon-desc">
                            この一覧更新最新順
                        </option>
                        <option name="order" value="add-addon-asc" id="order-add-addon-asc">
                            この一覧更新古い順
                        </option>
                        <option name="order" value="stars-desc" id="order-stars-desc">
                            GitHubスター数多い順
                        </option>
                        <option name="order" value="stars-asc" id="order-stars-asc">
                            GitHubスター少ない順
                        </option>
                        <option name="order" value="title-asc" id="order-title-asc">
                            アドオン名アルファベット順
                        </option>
                        <option name="order" value="title-desc" id="order-title-desc">
                            アドオン名アルファベット逆順
                        </option>
                        <option name="order" value="author-asc" id="order-author-asc">
                            作者名アルファベット順
                        </option>
                        <option name="order" value="author-desc" id="order-author-desc">
                            作者名アルファベット逆順
                        </option>
                    </select>
                </div>
                <!-- セパレーター  -->
                <hr>

                表示列数
                <div id="ColControls" style="margin-top: 1em ;" class="addon-display-columns"
                     data-collapse-toggle="display-col">
                </div>
            </div>
        </details>
    </div>
    <!--Grid-->
    <div class="grid-container">
        {{ if (fileExists $file) }}
        {{ with (os.Stat $file) }}
        <p>最終更新日時: {{ .ModTime.Format "2006-01-02 15:04" }}</p>
        {{ end }}
        {{ end }}

        <!--　件数 -->
        <div class="addon-count">
            <span id="AddonCount"></span>
        </div>

        <!-- JavaScriptからDOM構築するための空の検索結果一覧リスト -->
        <ul id="AddonFilteredList">
        </ul>

        <!-- アドオンカード　テンプレート -->
        <ul class="addon" style="display: none">
            <li>
                <span data-github-template><i class="fab fa-fw fa-github"></i></span>
                <span data-gitlab-template><i class="fab fa-fw fa-gitlab"></i></span>
                <span data-otherlink-template><i class="fas fa-fw fa-link"></i></span>
                <span data-star-template>★ </span>
            </li>
            <li class="addon sub-thumbnail" data-sub-thumbnail-template>
                <a href="" onclick="return showImagesLightBox();">
                    <img alt="" src=""/>
                </a>
            </li>
            <li data-template>
                <div class="addon addon-entry" style="transition: none">
                    <div class="addon post-div">
                        <header class="addon entry-header">
                            <div class="addon entry-header-row">
                                <h2 class="addon entry-hint-parent" data-entry-title>
                                    <a href="" target="_blank" data-entry-title-link>
                                        <span class="addon entry-icon" data-entry-icon></span>
                                    </a>
                                </h2>
                                <span class="addon entry-author-label" data-entry-author-label>
                                作者:
                            </span>
                                <span class="addon entry-author" data-entry-author></span>
                            </div>
                            <!-- tags -->
                            <ul class="addon entry-tags" data-entry-tags>
                                <li class="addon entry-license" data-entry-license></li>
                            </ul>
                        </header>
                        <div class="addon entry-content">
                            <!-- サムネイル -->
                            <div class="addon entry-thumbnail">
                                <img src="" alt="" data-entry-thumbnail-image>
                            </div>
                            <div class="addon entry-main">
                                <!-- サブサムネイル（説明画像） -->
                                <ul class="addon sub-images" data-entry-sub-images>
                                </ul>
                                <p class="addon entry-summary" data-entry-summary>

                                </p>
                                <div>
                                    <a class="addon entry-assetlib-link link" href="" data-entry-assetlib-link></a>
                                </div>
                            </div>
                        </div>
                        <footer class="addon entry-footer">
                        <span class="last-updated-label">
                            最終更新日:
                        </span>
                            <time class="last-updated" datetime="" data-entry-last-updated></time>
                            <span class="last-updated-label-list" data-entry-last-updated-list-label>
                            一覧追加日:
                        </span>
                            <time class="last-updated-list" datetime="" data-entry-last-updated-list></time>
                            <br>
                            <span class="addon entry-languages-label" data-entry-languages-label>
                            リポジトリ内訳:
                            <span class="addon entry-languages" data-entry-languages></span>
                        </span>
                        </footer>
                    </div>
                    <!--                <a class="addon entry-link" href=""></a>-->
                </div>
            </li>
        </ul>
    </div>
</article>
<script>

    <!-- prettier-ignore-start -->
    const DataList = {{ readFile "static/data/addon.json" | safeJS }};
    const DatalistEntries = Object.entries(DataList);
    let FilteredDataList = DatalistEntries;
    const TagsTrList = {{ readFile "static/data/tag_translation.json" | safeJS }};

    const DefaultThumbnail = "{{ "/icon/EditorPlugin.svg" | relURL }}";
    const YoutubeIcon = "{{ "/images/youtube_social_squircle_red.png" | relURL }}";

    const ThumbnailImageDirPath = "{{ "/images/addon/thumbnails/" | relURL }}";
    const ImageMovieThumbnailImageDirPath = "{{ "/images/addon/imagethumbnails/" | relURL }}";
    const ImageMovieOrgImageDirPath = "{{ "/images/addon/images/" | relURL }}";
    <!-- prettier-ignore-end -->

    document.addEventListener('DOMContentLoaded', () => {
        // ソートのセレクトが変更されたらupdateを呼び出す
        document.querySelector('select#addon-order').addEventListener('change', update);
        // 条件タグを生成
        createTags();

        // 除外タグを複製して生成する
        duplicateToExcludeConditionElms();

        // URLのクエリパラメータを条件・設定に適用
        applyURLParamToConditions();

        // 一覧データの初回表示
        update();

        // カードレイアウト(カラム数)を更新
        updateLayout();

        // ウィンドウリサイズ時にカードレイアウト(カラム数)を更新
        window.addEventListener('resize', updateLayout);

        // 折りたたみボタン
        const collapseBtns = document.querySelectorAll('[data-collapse-btn]');
        collapseBtns.forEach(btn => {
            // 行全体をクリック時にしたいので、ボタンの親要素にイベントを設定する
            btn.parentElement.addEventListener('click', () => {
                toggleCollapse(btn);
            });
            btn.parentElement.style.cursor = 'pointer';
            btn.parentElement.style.display = 'inline-block';
        });

        // 上部ピン留めボタン
        document.getElementById("PinBtn").addEventListener('click', () => {
            event.preventDefault();
            event.stopPropagation();
            const filterContainer = document.querySelector('.filter-container');
            filterContainer.classList.toggle('fixed-top');
            const pinBtn = document.querySelector('[data-pin-btn]');
            pinBtn.classList.toggle('pin-on');
        });

        // タグのチェックボックスが変更されたらupdateを呼び出す
        document.querySelectorAll('[data-check-tag]').forEach(function (el) {
            el.addEventListener('change', update);
        });
        // フィルターのラジオボタンが変更されたらupdateを呼び出す
        document.querySelectorAll('input[name="filter"]').forEach(function (el) {
            el.addEventListener('change', update);
        });

        //上にスクロールする
        window.scrollTo({
            top: 0,
            behavior: 'instant'
        });
    });

    /**
     * 全検索対象データJSONから一覧データの更新
     */
    function update() {
        const selectedTags = Array.from(document.querySelectorAll('input[name="tag"]:checked')).map(el => el.value);
        const filteredList = document.getElementById('AddonFilteredList');
        const template = document.querySelector('li[data-template]');

        const specialTags = Array.from(document.querySelectorAll('input[name="specialTag"]:checked')).map(el => el.value);
        const licenseTags = Array.from(document.querySelectorAll('input[name="licenseTag"]:checked')).map(el => el.value);

        const selectedExcludeTags = Array.from(document.querySelectorAll('input[name="excludeTag"]:checked')).map(el => el.value);
        const specialExcludeTags = Array.from(document.querySelectorAll('input[name="excludespecialTag"]:checked')).map(el => el.value);
        const licenseExcludeTags = Array.from(document.querySelectorAll('input[name="excludelicenseTag"]:checked')).map(el => el.value);
        // 一旦リストを空にする
        filteredList.innerHTML = '';

        let query = new URLSearchParams();
        selectedTags.forEach(tag => {
            query.append('tag', tag);
        });
        selectedExcludeTags.forEach(tag => {
            query.append('excludeTag', tag);
        });
        licenseTags.forEach(tag => {
            query.append('licensetag', tag);
        });

        const filterType = document.querySelector('input[name="filter"]:checked').value;
        query.append('filter', filterType);

        const order = document.querySelector('select#addon-order').value;
        query.append('order', order);

        const searchTarget = document.getElementById('SearchTarget').value;
        const search = document.getElementById('SearchInput').value;
        query.append('search', search);
        query.append('searchTarget', searchTarget);

        history.replaceState(null, '', `?${query.toString()}`);

        let count = 0;

        const locale = "{{ site.Language.Lang }}";

        const templategithub = document.querySelector('[data-github-template]');
        const templategitlab = document.querySelector('[data-gitlab-template]');
        const templateotherlink = document.querySelector('[data-otherlink-template]');
        const templatestar = document.querySelector('[data-star-template]');

        FilteredDataList = Object.entries(DataList)
            .filter(([key, value]) => {
                //specialTags
                //Tags
                if (key === 'tags') {
                    return false;
                }
                //specialTags
                if (specialTags.length === 0) {
                    return true;
                }

                if (filterType === 'or') {
                    return specialTags.some(tag => {
                        return checkConditionNotTag(tag, value);
                    });
                } else if (filterType === 'and') {
                    return specialTags.every(tag => {
                        return checkConditionNotTag(tag, value);
                    });
                }
                console.error('filter error');
            })
            .filter(([key, value]) => {
                //licenseTags
                if (licenseTags.length === 0) {
                    return true;
                }
                if (filterType === 'or') {
                    return licenseTags.some(tag => {
                        if (value.license_override !== "") {
                            return tag === value.license_override;
                        } else if (value.license !== "") {
                            return tag === value.license;
                        }
                    });
                } else if (filterType === 'and') {
                    return licenseTags.every(tag => {
                        if (value.license_override !== "") {
                            return tag === value.license_override;
                        } else if (value.license !== "") {
                            return tag === value.license;
                        }
                    });
                }
            })
            .filter(([key, value]) => {
                // 自動生成通常タグ
                return (filterType === 'or' && selectedTags.some(tag => value.tags.includes(tag))) || (filterType === 'and' && selectedTags.length === 0 || selectedTags.every(tag => value.tags.includes(tag)));
            })
            .filter(([key, value]) => {
                //specialExcludeTags
                //specialTags
                if (specialExcludeTags.length === 0) {
                    return true;
                }

                return specialExcludeTags.every(tag => {
                    return !checkConditionNotTag(tag, value);
                });
            })
            .filter(([key, value]) => {
                //licenseTags
                if (licenseExcludeTags.length === 0) {
                    return true;
                }
                return licenseExcludeTags.every(tag => {
                    if (value.license_override !== "") {
                        return tag !== value.license_override;
                    } else if (value.license !== "") {
                        return tag !== value.license;
                    }
                });
            })
            .filter(([key, value]) => {
                // 自動生成除外Tag
                return (selectedExcludeTags.length === 0 || selectedExcludeTags.every(tag => !value.tags.includes(tag)));
            })
            .filter(([key, value]) => {
                // 検索
                if (search === '') {
                    return true;
                }
                //部分一致
                if (searchTarget === 'any') {
                    return value.title.toLowerCase().includes(search.toLowerCase())
                        || value.owner.toLowerCase().includes(search.toLowerCase())
                        || value.summary_ja.toLowerCase().includes(search.toLowerCase());

                } else if (searchTarget === 'title') {
                    return value.title.toLowerCase().includes(search.toLowerCase());
                } else if (searchTarget === 'author') {
                    return value.owner.toLowerCase().includes(search.toLowerCase());
                } else if (searchTarget === 'summary') {
                    return value.summary_ja.toLowerCase().includes(search.toLowerCase());
                }
            })
            .sort((a, b) => {
                if (order === 'title-asc') {
                    return a[1].title.localeCompare(b[1].title, locale, {sensitivity: 'base'});
                } else if (order === 'title-desc') {
                    return b[1].title.localeCompare(a[1].title, locale, {sensitivity: 'base'});
                } else if (order === 'author-asc') {
                    if (a[1].owner === undefined || a[1].owner === null) {
                        return 1;
                    } else if (b[1].owner === undefined || b[1].owner === null) {
                        return -1;
                    }
                    return a[1].owner.localeCompare(b[1].owner, locale, {sensitivity: 'base'});
                } else if (order === 'author-desc') {
                    if (a[1].owner === undefined || a[1].owner === null) {
                        return 1;
                    } else if (b[1].owner === undefined || b[1].owner === null) {
                        return -1;
                    }
                    return b[1].owner.localeCompare(a[1].owner, locale, {sensitivity: 'base'});
                } else if (order === 'add-addon-desc') {
                    return new Date(b[1].listed_at) - new Date(a[1].listed_at);
                } else if (order === 'add-addon-asc') {
                    return new Date(a[1].listed_at) - new Date(b[1].listed_at);
                } else if (order === 'updated-addon-desc') {
                    // Dateでないものは最後に表示される
                    if (a[1].last_updated === "") {
                        return 1;
                    } else if (b[1].last_updated === "") {
                        return -1;
                    }
                    return new Date(b[1].last_updated) - new Date(a[1].last_updated);
                } else if (order === 'updated-addon-asc') {
                    // Dateでないものは最後に表示される
                    if (a[1].last_updated === "") {
                        return 1;
                    } else if (b[1].last_updated === "") {
                        return -1;
                    }
                    return new Date(a[1].last_updated) - new Date(b[1].last_updated);
                } else if (order === 'stars-desc') {
                    return b[1].stars - a[1].stars;
                } else if (order === 'stars-asc') {
                    return a[1].stars - b[1].stars;
                }
            })

        FilteredDataList.forEach(function ([key, value]) {
            if (value.title === undefined || value.title === null) {
                return;
            }

            const clone = template.cloneNode(true);

            // タイトル
            const title = clone.querySelector('[data-entry-title]');
            const a = title.querySelector('[data-entry-title-link]');
            a.href = value.url;

            // スター数
            if (value.repo_type !== 'github') {

            } else if (value.stars !== undefined && value.stars !== null) {
                const star = templatestar.cloneNode(true);
                star.appendChild(document.createTextNode(value.stars));
                title.appendChild(star);
                // 500以上の場合は濃い赤色にする
                if (value.stars >= 500) {
                    star.style.color = 'crimson';
                } else if (value.stars >= 100) {
                    star.style.color = 'orange';
                } else if (value.stars >= 50) {
                    star.style.color = 'green';
                }
            }

            // タイトルアイコン GitHub or GitLab or Other
            const entryIcon = title.querySelector('[data-entry-icon]');
            if (value.repo_type === 'github') {
                const cloneIcon = templategithub.cloneNode(true);
                entryIcon.appendChild(cloneIcon);
            } else if (value.repo_type === 'gitlab') {
                const cloneIcon = templategitlab.cloneNode(true);
                entryIcon.appendChild(cloneIcon);
            } else {
                const cloneIcon = templateotherlink.cloneNode(true);
                entryIcon.appendChild(cloneIcon);
            }

            // タイトル
            a.appendChild(document.createTextNode(value.title));

            // 作者
            if (value.repo_type !== 'unknown' && value.owner !== undefined && value.owner !== null) {
                if (value.owner === 'unknown') {
                    //entry-author-labelの削除
                    const authorLabel = clone.querySelector('[data-entry-author-label]');
                    authorLabel.style.display = 'none';
                } else {
                    const author = clone.querySelector('[data-entry-author]');
                    author.textContent = value.owner;
                }
            } else {
                //entry-author-labelの削除
                const authorLabel = clone.querySelector('[data-entry-author-label]');
                authorLabel.style.display = 'none';
            }

            // ライセンス

            if (value.license_override !== undefined &&
                value.license_override !== null &&
                value.license_override !== "") {
                const license = clone.querySelector('[data-entry-license]');
                license.textContent = value.license_override;
            } else if (value.license !== undefined &&
                value.license !== null &&
                value.license !== "") {
                const license = clone.querySelector('[data-entry-license]');
                license.textContent = value.license;
            } else {
                //entry-licenseの削除
                const license = clone.querySelector('[data-entry-license]');
                license.style.display = 'none';
            }

            // タグ
            const tagList = clone.querySelector('[data-entry-tags]');
            if (value.tags !== undefined && value.tags !== null) {
                value.tags.forEach(tag => {
                    try {
                        const li = document.createElement('li');
                        li.textContent = TagsTrList[tag].ja;
                        tagList.appendChild(li);
                    } catch (e) {
                        console.warn(`Tag translation not found: ${tag}`);
                        console.error(e);
                    }
                });
            }

            // サムネイル
            const thumbnail = clone.querySelector('[data-entry-thumbnail-image]');
            if (value.has_thumbnail) {
                thumbnail.src = ThumbnailImageDirPath + value.id + ".webp"
            } else {
                thumbnail.src = DefaultThumbnail;
            }

            // サブサムネイル(説明画像)
            const subimages = clone.querySelector('[data-entry-sub-images]');
            if (value.images !== undefined
                && value.images !== null
                && value.images.length > 0
            ) {
                value.images.forEach((thumbnail_extension, index) => {
                    const subThumbnail = document.querySelector('li[data-sub-thumbnail-template]').cloneNode(true);
                    const img = subThumbnail.querySelector('img');
                    const a = subThumbnail.querySelector('a');
                    const fileNameIndexStr = index === 0 ? "" : "_" + (index + 1).toString();

                    a.dataset.key = key;
                    a.dataset.index = index;
                    if (!['png', 'jpg', 'jpeg', 'webp', 'mp4', 'gif', "mov"].includes(thumbnail_extension)) {
                        // youtube
                        a.href = thumbnail_extension
                        img.src = YoutubeIcon;
                    } else {
                        a.href = ImageMovieThumbnailImageDirPath + value.id + fileNameIndexStr + "." + thumbnail_extension
                        img.src = ImageMovieThumbnailImageDirPath + value.id + fileNameIndexStr + ".webp";
                    }
                    subimages.appendChild(subThumbnail);
                });
            } else {
                // 0件の場合はサブサムネイルの非表示
                subimages.style.display = 'none';
            }

            // 概要
            clone.querySelector('[data-entry-summary]').innerHTML = value.summary_ja;

            // AssetLibリンク
            const assetlibLink = clone.querySelector('[data-entry-assetlib-link]');
            if (value.is_exists_assetlib && value.assetlib_path) {
                assetlibLink.href = value.assetlib_path;
                assetlibLink.textContent = 'AssetLib';
            } else {
                assetlibLink.style.display = 'none';
            }

            // プログラム言語
            const languages = clone.querySelector('[data-entry-languages]');
            if (value.languages !== undefined && value.languages !== null) {
                if (Object.keys(value.languages).length === 0) {
                    //entry-languages-labelの削除
                    const entryLanguagesLabel = clone.querySelector('[data-entry-languages-label]');
                    entryLanguagesLabel.style.display = 'none';

                    //entry-languagesの削除
                    const entryLanguages = clone.querySelector('[data-entry-languages]');
                    entryLanguages.style.display = 'none';
                }

                const lang = Object.entries(value.languages).map(([key, value]) => {
                    // const valueWithComma = value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                    // K単位で表示
                    const valueWithK = (value / 1000).toFixed(1);
                    return `${key}=${valueWithK}k`;
                }).join(', ');
                languages.textContent = lang;
            } else {
                //entry-languages-labelの削除
                const entryLanguagesLabel = clone.querySelector('[data-entry-languages-label]');
                entryLanguagesLabel.style.display = 'none';

                //entry-languagesの削除
                const entryLanguages = clone.querySelector('[data-entry-languages]');
                entryLanguages.style.display = 'none';
            }


            // 最終追加日
            if (value.listed_at !== undefined && value.listed_at !== null) {
                const lastUpdatedList = clone.querySelector('[data-entry-last-updated-list]');
                lastUpdatedList.textContent = new Date(value.listed_at).toLocaleDateString();
            } else {
                //last-updated-labelの削除
                const lastUpdatedLabelList = clone.querySelector('[data-entry-last-updated-list-label]');
                lastUpdatedLabelList.style.display = 'none';
            }

            // 最終更新日
            if (value.repo_type !== 'unknown' && value.last_updated !== undefined && value.last_updated !== null) {
                const lastUpdated = clone.querySelector('[data-entry-last-updated]');
                const lastUpdateDate = new Date(value.last_updated);

                // 日付が未設定の場合は表示しない
                if (isNaN(lastUpdateDate)) {
                    //last-updated-labelの削除
                    const lastUpdatedLabel = clone.querySelector('[data-entry-last-updated]');
                    lastUpdatedLabel.style.display = 'none';
                } else {

                    //更新がない間の期間を算出して表示する
                    const now = new Date();
                    const diff = now - lastUpdateDate;
                    const diffDays = diff / (1000 * 60 * 60 * 24);
                    if (diffDays < 1) {
                        lastUpdated.textContent = lastUpdateDate.toLocaleDateString() + " " + lastUpdateDate.toLocaleTimeString() + ` ${Math.floor(diff / (1000 * 60 * 60))}時間前`;
                        lastUpdated.style.color = 'green';
                    } else if (diffDays < 30) {
                        lastUpdated.textContent = lastUpdateDate.toLocaleDateString() + ` ${Math.floor(diffDays)}日前`;
                        lastUpdated.style.color = 'green';
                    } else if (diffDays < 365) {
                        lastUpdated.textContent = lastUpdateDate.toLocaleDateString() + ` ${Math.floor(diffDays)}日前`;
                    } else {
                        lastUpdated.textContent = lastUpdateDate.toLocaleDateString() + ` ${Math.floor(diffDays / 30)}ヶ月前`;
                    }
                }
            }


            // data-template属性を削除
            clone.removeAttribute('data-template');
            filteredList.appendChild(clone);
            count++;
        });

        document.getElementById('AddonCount').textContent = `${count} 件`;

        // Lightbox = GLightbox({
        //     touchNavigation: true,
        //     loop: true,
        //     autoplayVideos: true
        // });

        updateTags();
    }

    /**
     * タグJSONからタグを生成
     */
    function createTags() {
        const tagTemplate = document.querySelector('li[data-tag-template]');
        const fragment = document.createDocumentFragment();

        const licenseTagTemplate = document.querySelector('li[data-license-tag-template]');
        const licenseFragment = document.createDocumentFragment();
        const licenseTags = new Set();
        const locale = "{{ site.Language.Lang }}";
        DataList.tags
            .sort((a, b) => {
                let localedA = TagsTrList[a].ja;
                let localedB = TagsTrList[b].ja;
                return localedA.localeCompare(localedB, locale, {sensitivity: 'base'})
            })
            .forEach(tag => {
                const clone = tagTemplate.cloneNode(true);
                const input = clone.querySelector('[data-tag-checkbox]');
                input.value = tag;

                // タグのラベルに翻訳を設定
                const label = clone.querySelector('[data-tag-label]');
                label.dataset.generatedTag = "";
                try {
                    const span = label.querySelector('[data-tag-label-text]');
                    if (locale === "ja") {
                        span.innerText = TagsTrList[tag].ja;
                    } else if (locale === "ko") {
                        span.innerText = TagsTrList[tag].ko;
                    } else {
                        span.innerText = TagsTrList[tag].en;
                    }
                } catch (e) {
                    console.error(`Tag translation not found: ${tag}`);
                }

                clone.removeAttribute('data-tag-template');
                clone.style.display = '';

                // タグのチェックボックスが変更されたらupdateを呼び出す
                input.addEventListener('change', update);

                fragment.appendChild(clone);
            });

        document.getElementById("FilterTags").appendChild(fragment);

        Object.entries(DataList).forEach(([key, value]) => {
            if (value.license_override && value.license_override !== "") {
                licenseTags.add(value.license_override);
            } else if (value.license) {
                licenseTags.add(value.license);
            }
        });
        Array.from(licenseTags)
            .sort()
            .forEach(license => {
                const clone = licenseTagTemplate.cloneNode(true);
                const input = clone.querySelector('[data-tag-checkbox]');
                input.value = license;

                const label = clone.querySelector('[data-tag-label]');
                label.dataset.generatedLicenseTag = "";
                const span = label.querySelector('[data-tag-label-text]');
                span.innerText = license;

                clone.removeAttribute('data-license-tag-template');
                clone.style.display = '';

                // タグのチェックボックスが変更されたらupdateを呼び出す
                input.addEventListener('change', update);

                licenseFragment.appendChild(clone);
            });

        document.getElementById("FilterLicenseTags").appendChild(licenseFragment);
    }

    /**
     * タグのデータ数を更新
     */
    function updateTags() {
        // 最初からあるタグのデータ数を更新する
        document.querySelectorAll('[data-commonly-tag]').forEach(el => {
                const tag = el.querySelector('input').value;
                const count = FilteredDataList.filter(([key, value]) => {
                    if (key === 'tags') {
                        return false;
                    }
                    if (value.tags === undefined) {
                        return false;
                    }
                    return value.tags.includes(tag);
                }).length;
                //<sup>1</sup>
                const sup = el.querySelector('sup');
                sup.innerText = `${count}`;

                if (count === 0) {
                    el.classList.add('result-zero-tag');
                } else {
                    el.classList.remove('result-zero-tag');
                }
            }
        );
        document.querySelectorAll('[data-not-tag-condition]').forEach(el => {
                const tag = el.querySelector('input').value;
                const count = FilteredDataList.filter(([key, value]) => {
                    if (key === 'tags') {
                        return false;
                    }
                    if (value.tags === undefined) {
                        return false;
                    }
                    return checkConditionNotTag(tag, value);
                }).length;
                //<sup>1</sup>
                const sup = el.querySelector('sup');
                sup.innerText = `${count}`;
                if (count === 0) {
                    el.classList.add('result-zero-tag');
                } else {
                    el.classList.remove('result-zero-tag');
                }
            }
        );

        document.querySelectorAll("[data-generated-tag]").forEach(el => {
            const tag = el.querySelector('input').value;
            const count = FilteredDataList.filter(([key, value]) => {
                if (key === 'tags') {
                    return false;
                }
                if (value.tags === undefined) {
                    return false;
                }
                return value.tags.includes(tag);
            }).length;
            //<sup>1</sup>
            const sup = el.querySelector('sup');
            sup.innerText = `${count}`;
            if (count === 0) {
                el.classList.add('result-zero-tag');
            } else {
                el.classList.remove('result-zero-tag');
            }
        });

        document.querySelectorAll("[data-generated-license-tag]").forEach(el => {
            const tag = el.querySelector('input').value;
            const count = FilteredDataList.filter(([key, value]) => {
                if (key === 'tags') {
                    return false;
                }
                if (value.tags === undefined) {
                    return false;
                }
                if (value.license_override !== "") {
                    return tag === value.license_override;
                } else if (value.license !== "") {
                    return tag === value.license;
                }
            }).length;
            //<sup>1</sup>
            const sup = el.querySelector('sup');
            sup.innerText = `${count}`;
            if (count === 0) {
                el.classList.add('result-zero-tag');
            } else {
                el.classList.remove('result-zero-tag');
            }
        });
    }

    /**
     * URLパラメータを条件に適用
     * @param columnCount
     * @param isMax
     */
    function applyURLParamToConditions() {
        // URLのクエリパラメータを取得
        const urlParams = new URLSearchParams(window.location.search);
        const tags = urlParams.getAll('tag');
        tags.forEach(tag => {
            const el = document.querySelector(`input[value="${tag}"]`);
            if (el) {
                el.checked = true;
            }
        });
        const filter = urlParams.get('filter');
        if (filter) {
            const el = document.querySelector(`input[id="${filter}"]`);
            if (el) {
                el.checked = true;
            }
        }
        const order = urlParams.get('order');
        if (order) {
            const el = document.querySelector(`input[id="${order}"]`);
            if (el) {
                el.checked = true;
            }
        }
        const search = urlParams.get('search');
        if (search) {
            const el = document.getElementById('SearchInput');
            if (el) {
                el.value = search;
            }
        }
        const searchTarget = urlParams.get('searchTarget');
        if (searchTarget) {
            const el = document.getElementById('SearchTarget');
            if (el) {
                el.value = searchTarget;
            }
        }
    }

    /**
     * タグのチェックボックスが変更されたらupdateを呼び出す
     */
    function clearAll() {
        document.querySelectorAll('input[name="tag"]:checked').forEach(el => {
            el.checked = false;
        });
        document.querySelectorAll('input[name="specialTag"]:checked').forEach(el => {
            el.checked = false;
        });
        document.querySelectorAll('input[name="licenseTag"]:checked').forEach(el => {
            el.checked = false;
        });
        document.querySelectorAll('input[name="excludeTag"]:checked').forEach(el => {
            el.checked = false;
        });
        document.querySelectorAll('input[name="excludespecialTag"]:checked').forEach(el => {
            el.checked = false;
        });
        document.querySelectorAll('input[name="excludelicenseTag"]:checked').forEach(el => {
            el.checked = false;
        });
        document.getElementById('SearchInput').value = '';
        document.getElementById('SearchTarget').value = 'any';
        update();
    }

    /**
     * 折りたたみ処理
     * @param btn
     */
    /**
     * 条件要素を複製して除外条件要素を追加する
     */
    function duplicateToExcludeConditionElms() {
        // 除外条件をコピーする
        // #ForDuplicateExcludeをコピーして、その内の要素のすべてid,nameを変更する
        const excludeTags = document.getElementById('ExcludeTags');
        const orgExclude = document.getElementById('ForDuplicateExclude');
        const duplicatedExclude = orgExclude.cloneNode(true);
        duplicatedExclude.id = 'duplicated-exclude';
        duplicatedExclude.style.display = 'block';
        duplicatedExclude.querySelectorAll('input').forEach(el => {
            // id, nameを変更
            el.id = `exclude${el.id}`;
            el.name = `exclude${el.name}`;
        });
        //data-collapse-toggleを変更
        duplicatedExclude.querySelectorAll('[data-collapse-toggle]').forEach(el => {
            el.dataset.collapseToggle = '';
        });

        //すべてのタグ表示のテキスト,色を変更
        duplicatedExclude.querySelectorAll('[data-tag-head]').forEach(el => {
            el.textContent += '(除外)';
            el.style.color = 'red';
        });

        excludeTags.appendChild(duplicatedExclude);
    }

    /**
     * カードレイアウト(カラム数)を更新する
     */
    function updateLayout() {
        const container = document.getElementById('AddonFilteredList');
        const controls = document.getElementById('ColControls');
        const itemWidth = 740;

        const containerParentWidth = container.clientWidth;

        // const maxColumns = Math.floor(containerParentWidth / itemWidth);
        // gapを考慮する 20px
        const maxColumns = Math.floor(containerParentWidth / itemWidth);

        //初期化
        controls.innerHTML = '';

        // ラジオボタンの更新
        for (let i = 1; i <= maxColumns; i++) {
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.id = `Col${i}`;
            radio.name = 'columns';
            radio.value = i;
            radio.addEventListener('change', () => applyColumnCount(i, i === maxColumns));

            const label = document.createElement('label');
            label.htmlFor = `Col${i}`;

            label.appendChild(radio);
            controls.appendChild(label);

            let text = i.toString();
            if (i === maxColumns) {
                text = '幅いっぱい';
            }
            label.appendChild(document.createTextNode(text));
        }

        // デフォルトで最大列数を選択
        const defaultRadio = document.getElementById(`Col${maxColumns}`);
        if (defaultRadio) {
            defaultRadio.checked = true;
            applyColumnCount(maxColumns, true);
        }
    }

    /**
     * カラム数を更新する
     * @param columnCount
     * @param isMax
     */
    function applyColumnCount(columnCount, isMax = false) {
        const container = document.getElementById('AddonFilteredList');
        const itemWidth = 740;
        container.style.gridTemplateColumns = `repeat(${columnCount}, ${itemWidth}px)`;
    }

    /**
     * 特別な判定をするチェックボックスの条件を満たすかどうか
     * @param tag
     * @param value
     * @returns {*|boolean}
     */
    function checkConditionNotTag(tag, value) {
        if (tag === 'assetlib') {
            return value.is_exists_assetlib;
        } else if (tag === 'notassetlib') {
            return value.is_exists_assetlib || value.assetlib_path === '';
        } else if (tag === 'github') {
            return value.repo_type === 'github';
        } else if (tag === 'gitlab') {
            return value.repo_type === 'gitlab';
        } else if (tag === 'other') {
            return value.repo_type !== 'github' && value.repo_type !== 'gitlab';
        } else if (tag === 'notdemo') {
            if (value.tags === undefined) {
                return false;
            }
            return !value.tags.includes('demo');
        } else if (tag === 'withsummary') {
            return value.summary_ja !== '' && value.summary_ko !== '' && value.summary_en !== '';
        }
    }

    /**
     * GLightboxを使って画像を表示する
     * @returns {boolean}
     */
    function showImagesLightBox() {
        const clicked = event.target;

        const data = DataList[clicked.dataset.key];
        const elements = data.images.map((thumbnail_extension, index) => {

            // 画像
            if (['png', 'jpg', 'jpeg', 'webp', "gif"].includes(thumbnail_extension)) {
                const fileNameIndexStr = index === 0 ? "" : "_" + (index + 1).toString();
                return {
                    href: ImageMovieOrgImageDirPath + data.id + fileNameIndexStr + "." + thumbnail_extension,
                    type: 'image'
                };
            } else if (['mp4', 'webm', "mov"].includes(thumbnail_extension)) {
                const fileNameIndexStr = index === 0 ? "" : "_" + (index + 1).toString();
                return {
                    href: ImageMovieOrgImageDirPath + data.id + fileNameIndexStr + "." + thumbnail_extension,
                    type: 'video'
                };
            } else {
                // youtube
                return {
                    href: thumbnail_extension,
                    type: 'video'
                };
            }
        });
        GLightbox(
            {
                elements: elements,
                touchNavigation: true,
                loop: true,

                autoplayVideos: true
            }
        ).openAt(clicked.dataset.index);

        return false;
    }
</script>

{{- end }}{{/* end main */}}